name: Newman API Tests

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  run-api-tests:
    runs-on: ubuntu-latest

    steps:
      - name: âœ… Checkout repository
        uses: actions/checkout@v3

      - name: ðŸ› ï¸ Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: ðŸ“¦ Install backend dependencies
        run: |
          npm install

      - name: ðŸš€ Start backend API (background)
        run: |
          nohup node server.js > server.log 2>&1 &
          sleep 5

      - name: ðŸ“¦ Install Newman + HTML Extra reporter
        run: |
          npm install -g newman newman-reporter-htmlextra

      - name: ðŸš€ Run Newman Test Suite
        continue-on-error: true
        run: |
          mkdir -p reports
          newman run "postman/User_API_Collection.postman_collection.json" \
            -e "postman/User_API_Local.postman_environment.json" \
            --iteration-data "postman/user_api_iterations.json" \
            -r htmlextra \
            --reporter-htmlextra-export "reports/gestionProfil.html"

      - name: ðŸ“¤ Upload HTML test report as artifact
        id: upload-report
        uses: actions/upload-artifact@v4
        with:
          name: newman-test-report
          path: reports/gestionProfil.html

      - name: ðŸ“ Add HTML report link to summary
        run: |
          echo "### âœ… Rapport Newman gÃ©nÃ©rÃ©" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ‘‰ [TÃ©lÃ©charger / Voir le rapport](${{ steps.upload-report.outputs.artifact-url }})" >> $GITHUB_STEP_SUMMARY

      - name: ðŸªµ Show server logs (debug si serveur crash)
        if: always()
        run: cat server.log
